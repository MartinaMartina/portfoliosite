/**
 * Youxi Builder Models JS
 *
 * This script contains the page builder Backbone Models
 *
 * @package   Youxi Builder
 * @author    Mairel Theafila <maimairel@yahoo.com>
 * @copyright Copyright (c) 2013, Mairel Theafila
 */
jQuery.Youxi=jQuery.Youxi||{};(function(g,m,n,p){var c,h,k,e,l;c=g.Youxi.Builder=function(a){return new c.view.Wrapper(a)};_.extend(c,{model:{},view:{},controller:{}});k=c.l10n=_.isUndefined(_youxiBuilderL10n)?{}:_youxiBuilderL10n;c.settings=k.settings||{};delete k.settings;h=c.settings.shortcodes=g.extend(!0,{},youxiShortcodeSettings.args||{});h.tags=_.flatten(_.map(h.categories||[],function(a){return _.keys(a.shortcodes)})).concat(_.keys(h.orphans));c.Shortcode={regex:wp.shortcode.regexp(h.tags.join("|")),attrs:_.memoize(function(a){var b={},f,d;f=/([\w-]+)\s*=\s*"([^"]*)"(?:\s|$)|([\w-]+)\s*=\s*'([^']*)'(?:\s|$)|([\w-]+)\s*=\s*([^\s'"]+)(?:\s|$)|"([^"]*)"(?:\s|$)|(\S+)(?:\s|$)/g;for(a=a.replace(/[\u00a0\u200b]/g," ");d=f.exec(a);)d[1]?b[d[1].toLowerCase()]=d[2]:d[3]?b[d[3].toLowerCase()]=d[4]:d[5]?b[d[5].toLowerCase()]=d[6]:""!==d[7]?b[d[7]]=!0:""!==d[8]&&(b[d[8]]=!0);return b}),toJSON:function(a){var b,f=[],d=this.regex;for(d.lastIndex=0;b=d.exec(a);)if("["!==b[1]||"]"!==b[7]){var c=this.attrs(b[3]),e=b[5],h=d.lastIndex;e&&(e=g.Youxi.Shortcode.getSetting(b[2],"escape")?jQuery.trim(e):this.toJSON(e));f.push({tag:b[2],atts:c,content:e});d.lastIndex=h}return f.length?f:jQuery.trim(a)}};c.Helpers={getValidationStates:_.memoize(function(a,b){if(_.has(c.settings.rules,a)){var f=c.settings.rules[a],d={accept:!0,reject:!1};_.each(_.keys(d),function(a){_.has(f,a)&&(_.isArray(f[a])?d[a]=-1<_.indexOf(f[a],b):d[a]=_.isString(f[a])&&"*"==f[a])});return d}},function(){return"builder.Helpers.getValidationStates("+_.toArray(arguments).join(",")+")"}),getWrapperView:function(a){switch(a.get("type")){case "root":return c.settings.enableContainer?new c.view.Container({parent:a.view,tag:c.settings.columnContainerShortcode}):new c.view.Row({parent:a.view,tag:c.settings.rowShortcode});case "container":return new c.view.Row({parent:a.view,tag:c.settings.rowShortcode});case "row":var b=a.get("slots");if(0<b)return new c.view.Column({parent:a.view,tag:c.settings.columnShortcode,size:b})}},getShortcodeClass:function(a){return c.settings.enableContainer&&-1<_.indexOf(c.settings.containerShortcodes,a)?c.view.Container:a==c.settings.rowShortcode?c.view.Row:a==c.settings.columnShortcode?c.view.Column:c.view.Widget}};c.model.ShortcodeButton=Backbone.Model.extend({defaults:{tag:"",label:"",atts:"",dataset:{}},initialize:function(){var a={"data-tag":this.get("tag")};_.isEmpty(this.get("atts"))||_.extend(a,{"data-atts":JSON.stringify(this.get("atts"))});this.set("dataset",a)}},{getTabs:function(){return _.map(h.categories||[],function(a){a=a.args.label;return{href:a.toLowerCase().replace(/[^a-z0-9]/gi,"-"),label:a}})},getItems:function(){return _.map(h.categories||[],function(a){var b=a.args.label;a=g.map(a.shortcodes,function(a,b){if(!a.internal&&(c.settings.enableContainer||0>_.indexOf(c.settings.containerShortcodes,b)))return new c.model.ShortcodeButton(_.extend({},a,{tag:b}))});return{id:b.toLowerCase().replace(/[^a-z0-9]/gi,"-"),collection:new Backbone.Collection(a)}})}});e=c.controller.Base=Backbone.Model.extend({defaults:{tag:"",atts:{},content:"",type:""},constructor:function(a){a&&a.view&&(this.view=a.view,delete a.view);Backbone.Model.apply(this,arguments)},initialize:function(){this.view.on("initialized",this.viewInitialized,this);this.view.on("copy",this.copy,this);this.view.on("edit",this.edit,this);this.view.on("add:view",this.addViewHandler,this);this.view.on("remove:view",this.removeViewHandler,this)},sortableOptions:function(){var a=this;return{tolerance:"pointer",items:"> .youxi-builder-panel",handle:".youxi-builder-panel-header",cancel:"a.button",connectWith:".youxi-builder-"+this.get("type")+"-cw",start:function(b,c){c.placeholder.css({width:c.item[0].style.width}).append('<div class="youxi-builder-panel-inner"></div>');c.helper.css({width:c.placeholder.outerWidth()});a.view.spawn("sort:subview:start",a.getMessageHash(this,c.item));a.view.childContainer&&a.view.childContainer.$el.sortable("refresh")},remove:function(b,f){var d=f.item.data("backbone.view");d instanceof c.view.Panel&&a.view.removeView(d,{silent:!0})},update:function(b,c){null==c.sender&&a.compile()},receive:function(b,f){var d=f.item.data("backbone.view");d instanceof c.view.Panel&&a.view.maybeAddView(d,{at:f.item.index(),silent:!0})},stop:function(b,c){a.view.spawn("sort:subview:stop",a.getMessageHash(this,c.item))}}},droppableOptions:function(){var a=this;return{scope:"youxi-builder",greedy:"root"!=this.get("type"),hoverClass:"ui-state-hover",tolerance:"pointer",accept:function(b){return b.is(".youxi-builder-component")&&!b.data("isDropped")&&a.validateDrop(b.data("tag"))},drop:function(b,c){var d=c.draggable.data(),d=_.extend({coords:{x:b.pageX,y:b.pageY}},_.pick(d,"tag"),d.atts||{});a.validateDrop(d.tag)&&(a.view.handleDropped.apply(a.view,[d]),c.draggable.data("isDropped",!0))}}},getShortcodeObject:function(){return g.extend(!0,{},this.get("atts")||{},{content:this.get("content")})},toShortcode:function(){var a;if(a=this.view.getChildViews(!0))a=_.map(a,function(a){return a.controller.toShortcode()}).join("\n\n"),this.set({content:a},{silent:!0});return"root"==this.get("type")?this.get("content"):g.Youxi.Shortcode.construct(this.get("tag"),this.getShortcodeObject())},edit:function(){var a=this.get("tag");g.Youxi.Shortcode.Editor(a,this.getShortcodeObject(),_.bind(function(b){if(_.isObject(b)&&_.has(b,a)){var c=_.omit(b[a],"content");b=_.has(b[a],"content")?b[a].content:"";this.set({atts:c,content:b})}},this))},copy:function(){this.view.spawn("copy:view",{object:c.Shortcode.toJSON(this.toShortcode())})},viewInitialized:g.noop,addViewHandler:function(a,b){a.controller&&(a.controller.on("change:tag",this.compile,this),a.controller.on("change:atts",this.compile,this),a.controller.on("change:content",this.compile,this));a.parent=this.view;b&&b.populate||this.compile()},removeViewHandler:function(a,b){a.controller&&a.controller.off(null,null,this);a.parent&&delete a.parent;b&&b.populate||this.compile()},toView:function(a){var b=this.getValidationStates(a.tag);if(g.isPlainObject(b)&&!b.reject){if(b.accept)return new (c.Helpers.getShortcodeClass(a.tag))(_.extend(a,{parent:this.view}));b=c.Helpers.getWrapperView(this);if(b instanceof c.view.Panel)return b.maybeAddView(a),b}},compile:function(){"root"==this.get("type")?this.view.trigger("insert:tinymce",this.toShortcode()):this.view.spawn("compile:shortcode")},populate:function(a,b){_.isString(a)?this.set("content",a):_.each(_.isArray(a)?a:[a],function(a){if(g.isPlainObject(a)&&_.has(a,"tag")){var d=this.getValidationStates(a.tag);if(g.isPlainObject(d)&&d.accept){var d=new (c.Helpers.getShortcodeClass(a.tag))({parent:this.view,tag:a.tag}),e=g.extend(!0,{},a.atts||{},{content:a.content}),h;for(h in e)e[h]=g.Youxi.Shortcode.deserialize(a.tag,h,e[h]);d.populate(a.content);d.controller&&d.controller.set({atts:_.omit(e,"content"),content:e.content});this.view.maybeAddView(d,_.extend(b||{},{populate:!0}))}}},this);b&&b.compile&&this.compile()},getMessageHash:function(a,b){return{originalSource:this.view}},getValidationStates:function(a){return c.Helpers.getValidationStates(this.get("tag"),a)},validateDrop:function(a){a=this.getValidationStates(a);return g.isPlainObject(a)&&!a.reject},dispose:function(){this.view&&this.view.off&&this.view.off(null,null,this);_.each(this.view.getChildViews()||[],function(a){a.controller&&a.controller.off&&a.controller.off(null,null,this)},this)}});c.controller.Row=e.extend({defaults:function(){return _.extend({},e.prototype.defaults,{slots:c.settings.rowSize})},validateDrop:function(a){return e.prototype.validateDrop.apply(this,arguments)&&1<=this.get("slots")},validate:function(a,b){if(1>a.slots||a.slots>c.settings.rowSize)return k.invalidRowSlotsSize},updateSlots:function(a,b){var c=a.previous("size"),d=this.get("slots");g.isNumeric(c)&&this.set("slots",d+c-b)},addViewHandler:function(a){a instanceof c.view.Panel&&(this.set("slots",this.get("slots")-a.controller.get("size")),a.controller.on("change:size",this.updateSlots,this));e.prototype.addViewHandler.apply(this,arguments)},removeViewHandler:function(a){a instanceof c.view.Panel&&this.set("slots",this.get("slots")+a.controller.get("size"));e.prototype.removeViewHandler.apply(this,arguments)},getMessageHash:function(a,b){var f=b.data("backbone.view"),d=e.prototype.getMessageHash.apply(this,arguments);b.is(".youxi-builder-column")&&f instanceof c.view.Panel&&_.extend(d,{columnSize:f.controller.get("size")});return d}});l=c.controller.Column=e.extend({defaults:function(){return _.extend({},e.prototype.defaults,{size:c.settings.rowSize,offset:0})},initialize:function(){e.prototype.initialize.apply(this,arguments);this.view.on("increase decrease",this.resize,this);this.on("change:atts",this.synchronize,this);this.on("change:size",this.synchronize,this)},viewInitialized:function(){this.trigger("change:size",this,this.get("size"))},validate:function(a,b){if(1>a.size||a.size>c.settings.rowSize)return k.invalidColumnSize;if(this.view.spawn("request:slots!")<a.size-this.get("size"))return k.notEnoughColumnSlots},copy:g.noop,resize:function(a){if(_.isElement(a.currentTarget)){a=g(a.currentTarget).data("action");var b=this.get("size");"increase"==a?b<c.settings.rowSize&&this.set({size:b+1},{validate:!0}):"decrease"==a&&1<b&&this.set({size:b-1},{validate:!0})}},synchronize:function(a,b){var c=l.getDefaultSizeAtts(),d=l.getDefaultOffsetAtts();g.isPlainObject(b)&&_.has(b,c)?(c={size:parseInt(b[c])},_.has(b,d)&&(c.offset=parseInt(b[d])),this.set(c)):g.isNumeric(b)&&(d=_.extend({},this.get("atts")),d[c]=parseInt(b),this.set({atts:d}));this.view.refresh()}},{isColumnContainer:function(a){return a===c.settings.columnContainerShortcode},getDefaultOffsetAtts:function(){return"offset_"+c.settings.columnDefaultType},getDefaultSizeAtts:function(){return"size_"+c.settings.columnDefaultType},getTitle:_.memoize(function(a){return k.columnTitlePrefix+[a,c.settings.rowSize].join("/")})})})(jQuery,window,document);